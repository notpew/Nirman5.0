<!DOCTYPE html>
<html class="scroll-smooth" lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>
   Farmer Profile - Heisenberg Protocol
  </title>
  <!-- Poppins Typography -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
  <!-- Tailwind CSS (Play CDN) -->
  <script src="https://cdn.tailwindcss.com">
  </script>
  <script>
   tailwind.config = {
    theme: {
        extend: {
            fontFamily: {
                sans: ['Poppins', 'ui-sans-serif', 'system-ui']
            },
            colors: {
                brand: {
                    green: '#2E7D32'
                }
            }
        }
    }
}
  </script>
  <!-- Font Awesome 6 -->
  <link crossorigin="anonymous" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-dP7fZ1zAq3YV8vWn8NwGqP1U2oV1s3Qp2v1wY7m1yM7yWQ7yR5xj7qk4Y8eNfP+q9QxGvQXzqTnU3Qf8Zl6Z7w==" referrerpolicy="no-referrer" rel="stylesheet">
   <!-- SweetAlert2 -->
   <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11">
   </script>
   <!-- ApexCharts -->
   <script src="https://cdn.jsdelivr.net/npm/apexcharts">
   </script>
   <!-- Site Theme CSS -->
   <link href="style.css" rel="stylesheet"/>
   <!-- Page-specific CSS (Farmer Profile) -->
   <style>
    /* Page-specific minimal styles to complement global theme without altering shared components */
    body { font-family: 'Poppins', sans-serif; }
    .page-container { min-height: calc(100vh - 4rem - 64px); }
    .section-divider { border-top: 1px solid #e5e7eb; }
    .input-label { font-weight: 500; color: #334155; }
    .readonly-input { background-color: #f9fafb; }
    .badge { display: inline-flex; align-items: center; gap: 6px; border-radius: 9999px; padding: 4px 10px; font-size: 12px; }
    .badge-green { background-color: #ecfdf5; color: #15803d; }
    .list-row:hover { background-color: #f9fafb; }
    .dark .list-row:hover { background-color: #0f172a; }
    .btn { transition: all 150ms ease; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }
   </style>
  </link>
 
<!-- CSS Loader Script -->
<script src="./css_loader.js"></script>
</head>
 <body class="bg-gray-50 text-gray-800">
  <!-- Header (Common Component) -->
  <header class="w-full bg-white border-b border-[#2E7D32] sticky top-0 z-50">
   <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex h-16 items-center justify-between">
     <div class="flex items-center gap-3">
      <img alt="YieldWise " class="h-9 w-auto" onerror="this.src='https://ibb.co/JW4DnZwH'" src="https://i.ibb.co/p68Y2qBd/Logo-02.png" alt="Logo-02"/>
      <span class="text-xl font-semibold text-[#2E7D32]">
       Heisenberg Protocol
      </span>
      <span class="ml-2 text-sm text-gray-500">
       Farmer
      </span>
     </div>
     <div class="flex-1 max-w-xl mx-6 hidden md:block">
      <div class="relative">
       <input class="w-full border border-gray-300 rounded-md pl-10 pr-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-[#2E7D32] focus:border-[#2E7D32]" placeholder="Search features, tips, reports..." type="text"/>
       <i class="fas fa-search absolute left-3 top-2.5 text-gray-400">
       </i>
      </div>
     </div>
     <div class="flex items-center gap-2">
      <a class="hidden sm:inline-flex items-center gap-2 px-3 py-2 text-sm font-medium text-white bg-[#2E7D32] rounded-md hover:opacity-90" href="./smart_advisory.html">
       <i class="fas fa-magic">
       </i>
       Generate Advisory
      </a>
      <button class="p-2 rounded hover:bg-gray-100" title="Notifications">
       <i class="fas fa-bell text-gray-700">
       </i>
      </button>
      <button class="p-2 rounded hover:bg-gray-100" title="Messages">
       <i class="fas fa-comment-alt text-gray-700">
       </i>
      </button>
      <details class="relative">
       <summary class="list-none cursor-pointer flex items-center gap-2">
        <img alt="User" class="h-8 w-8 rounded-full" onerror="this.src='https://ibb.co/RpZL1PWH'" src="https://i.ibb.co/XZNm9pTJ/Default-male-avatar.webp"/>
        <span class="text-sm text-gray-700">
         Farmer
        </span>
        <i class="fas fa-chevron-down text-gray-500">
        </i>
       </summary>
       <div class="absolute right-0 mt-2 w-52 bg-white border border-gray-200 rounded-md shadow-lg">
        <a class="block px-3 py-2 text-sm text-gray-700 hover:bg-gray-50" href="./farmer_profile.html">
         <i class="fas fa-user mr-2">
         </i>
         Profile
        </a>
        <a class="block px-3 py-2 text-sm text-gray-700 hover:bg-gray-50" href="./farmer_profile.html#reports">
         <i class="fas fa-folder-open mr-2">
         </i>
         My Reports
        </a>
        <a class="block px-3 py-2 text-sm text-gray-700 hover:bg-gray-50" href="./tools_page.html">
         <i class="fas fa-tools mr-2">
         </i>
         Tools
        </a>
        <div class="border-t border-gray-200">
        </div>
        <a class="block px-3 py-2 text-sm text-gray-700 hover:bg-gray-50" href="#">
         <i class="fas fa-sign-out-alt mr-2">
         </i>
         Logout
        </a>
       </div>
      </details>
     </div>
    </div>
   </div>
  </header>
  <div class="max-w-7xl mx-auto page-container">
   <!-- Main Layout: Sidebar + Content -->
   <div class="flex">
    <!-- Sidebar (Common Component) - shown on dashboard/profile pages -->
    <aside class="hidden md:block w-64 bg-white border-r border-gray-200 min-h-screen pt-4 px-2" id="sidebar-farmer">
     <nav class="space-y-3">
      <h3 class="px-3 text-xs font-semibold text-gray-500 uppercase">
       Farmer
      </h3>
      <a class="group flex items-center gap-3 px-3 py-2 text-gray-700 rounded-md hover:bg-green-50 hover:text-[#2E7D32]" href="./home_dashboard.html">
       <i class="fas fa-home text-[#2E7D32]">
       </i>
       <span>
        Home Dashboard
       </span>
      </a>
      <a class="group flex items-center gap-3 px-3 py-2 text-gray-700 rounded-md hover:bg-green-50 hover:text-[#2E7D32] bg-green-50 text-[#2E7D32] font-medium" href="./farmer_profile.html">
       <i class="fas fa-user text-[#2E7D32]">
       </i>
       <span>
        Farmer Profile
       </span>
      </a>
      <details class="px-3 py-2 rounded-md">
       <summary class="flex items-center gap-3 cursor-pointer text-gray-700 hover:text-[#2E7D32]">
        <i class="fas fa-seedling text-[#2E7D32]">
        </i>
        <span>
         Advisory
        </span>
       </summary>
       <div class="mt-2 ml-6 space-y-1">
        <a class="block px-2 py-1 text-sm text-gray-600 hover:text-[#2E7D32]" href="./smart_advisory.html">
         <i class="fas fa-clipboard-list mr-2">
         </i>
         Smart Advisory
        </a>
        <a class="block px-2 py-1 text-sm text-gray-600 hover:text-[#2E7D32]" href="./advisory_report.html">
         <i class="fas fa-file-alt mr-2">
         </i>
         Latest Report
        </a>
        <a class="block px-2 py-1 text-sm text-gray-600 hover:text-[#2E7D32]" href="./farmer_profile.html#reports">
         <i class="fas fa-folder-open mr-2">
         </i>
         Saved Reports
        </a>
       </div>
      </details>
      <details class="px-3 py-2 rounded-md">
       <summary class="flex items-center gap-3 cursor-pointer text-gray-700 hover:text-[#2E7D32]">
        <i class="fas fa-store text-[#2E7D32]">
        </i>
        <span>
         Market &amp; Tools
        </span>
       </summary>
       <div class="mt-2 ml-6 space-y-1">
        <a class="block px-2 py-1 text-sm text-gray-600 hover:text-[#2E7D32]" href="./market_price.html">
         <i class="fas fa-chart-line mr-2">
         </i>
         Market Price
        </a>
        <a class="block px-2 py-1 text-sm text-gray-600 hover:text-[#2E7D32]" href="./tools_page.html">
         <i class="fas fa-tools mr-2">
         </i>
         Tools
        </a>
       </div>
      </details>
      <a class="group flex items-center gap-3 px-3 py-2 text-gray-700 rounded-md hover:bg-green-50 hover:text-[#2E7D32]" href="./government_schemes.html">
       <i class="fas fa-hands-helping text-[#2E7D32]">
       </i>
       <span>
        Government Schemes
       </span>
      </a>
     </nav>
    </aside>
    <!-- Content Area -->
    <main class="flex-1">
     <section class="px-4 sm:px-6 lg:px-8 py-6">
      <div class="mb-6 flex items-center justify-between">
       <div>
        <h1 class="text-2xl font-semibold text-[#2E7D32]">
         Farmer Profile
        </h1>
        <p class="text-gray-600 text-sm">
         Manage your personal and farm details. Your data stays on your device and powers personalized advisory.
        </p>
       </div>
       <div class="flex items-center gap-2">
        <button aria-label="Toggle dark mode" class="px-3 py-2 text-sm border rounded-md hover:bg-gray-100 btn" id="darkModeToggle">
         <i class="fas fa-moon text-gray-700">
         </i>
        </button>
        <a class="px-3 py-2 text-sm border rounded-md hover:bg-gray-100 btn" href="./language_selection.html">
         <i class="fas fa-language text-[#2E7D32] mr-1">
         </i>
         Language
        </a>
       </div>
      </div>
      <!-- Profile Manager: ProfileForm -->
      <div class="bg-white rounded-lg shadow border border-gray-200">
       <div class="px-4 py-4 sm:px-6 sm:py-5 flex items-center justify-between">
        <div class="flex items-center gap-3">
         <i class="fas fa-id-card text-[#2E7D32]">
         </i>
         <h2 class="text-lg font-semibold text-gray-800">
          Your Details
         </h2>
         <span class="badge badge-green">
          <i class="fas fa-shield-alt">
          </i>
          Local Only
         </span>
        </div>
        <button class="btn px-3 py-2 text-sm font-medium text-white bg-[#2E7D32] rounded-md hover:opacity-90" id="profileActionBtn">
         Edit Profile
        </button>
       </div>
       <div class="px-4 sm:px-6 pb-6">
        <form class="grid grid-cols-1 md:grid-cols-2 gap-4" id="profileForm">
         <!-- Name -->
         <div>
          <label class="input-label" for="userName">
           Name
          </label>
          <input class="form-input w-full border border-gray-300 rounded-md px-3 py-2 mt-1 readonly-input" disabled="" id="userName" placeholder="Enter your name" required="" type="text">
           <p class="text-red-600 text-xs mt-1 hidden" id="errorName">
            Please enter your name.
           </p>
          </input>
         </div>
         <!-- District -->
         <div>
          <label class="input-label" for="userDistrict">
           District
          </label>
          <input class="form-input w-full border border-gray-300 rounded-md px-3 py-2 mt-1 readonly-input" disabled="" id="userDistrict" placeholder="Enter your district" required="" type="text"/>
          <p class="text-red-600 text-xs mt-1 hidden" id="errorDistrict">
           Please enter your district.
          </p>
         </div>
         <!-- Land Size -->
         <div>
          <label class="input-label" for="landSize">
           Land Size (acres)
          </label>
          <input class="form-input w-full border border-gray-300 rounded-md px-3 py-2 mt-1 readonly-input" disabled="" id="landSize" min="0" placeholder="e.g., 2.5" required="" step="0.1" type="number"/>
          <p class="text-red-600 text-xs mt-1 hidden" id="errorLandSize">
           Please enter a valid land size.
          </p>
         </div>
         <!-- Preferred Crop -->
         <div>
          <label class="input-label" for="preferredCrop">
           Preferred Crop
          </label>
          <input class="form-input w-full border border-gray-300 rounded-md px-3 py-2 mt-1 readonly-input" disabled="" id="preferredCrop" placeholder="e.g., Wheat" type="text"/>
         </div>
        </form>
        <div class="mt-4 flex items-center gap-3">
         <button class="px-3 py-2 text-sm border rounded-md hover:bg-gray-100 btn" id="readProfileBtn">
          <i class="fas fa-volume-up text-[#2E7D32] mr-2">
          </i>
          Read Aloud
         </button>
         <a class="px-3 py-2 text-sm text-white bg-[#2E7D32] rounded-md hover:opacity-90 btn" href="./smart_advisory.html">
          <i class="fas fa-seedling mr-2">
          </i>
          Get Advisory
         </a>
        </div>
       </div>
      </div>
      <!-- Divider -->
      <div class="section-divider my-6">
      </div>
      <!-- Saved Reports List -->
      <div class="bg-white rounded-lg shadow border border-gray-200" id="reports">
       <div class="px-4 py-4 sm:px-6 sm:py-5 flex items-center justify-between">
        <div class="flex items-center gap-3">
         <i class="fas fa-folder-open text-[#2E7D32]">
         </i>
         <h2 class="text-lg font-semibold text-gray-800">
          My Saved Reports
         </h2>
        </div>
        <div class="flex items-center gap-2">
         <div class="relative">
          <input class="w-48 border border-gray-300 rounded-md pl-9 pr-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-[#2E7D32] focus:border-[#2E7D32]" id="reportSearch" placeholder="Search crop, location..." type="text"/>
          <i class="fas fa-search absolute left-3 top-2.5 text-gray-400">
          </i>
         </div>
         <select class="border border-gray-300 rounded-md px-2 py-2 text-sm" id="sortSelect">
          <option value="date_desc">
           Sort: Date (newest)
          </option>
          <option value="date_asc">
           Sort: Date (oldest)
          </option>
          <option value="crop_asc">
           Sort: Crop (A-Z)
          </option>
          <option value="crop_desc">
           Sort: Crop (Z-A)
          </option>
         </select>
        </div>
       </div>
       <!-- Reports Table/List -->
       <div class="px-4 sm:px-6 pb-4">
        <div class="hidden border border-dashed border-gray-300 rounded-md p-6 text-center text-gray-600" id="emptyState">
         <i class="fas fa-info-circle text-[#2E7D32] mb-2">
         </i>
         <p>
          You have no saved reports. Generate one from the Smart Advisory page!
         </p>
         <a class="mt-3 inline-flex items-center gap-2 px-3 py-2 text-sm font-medium text-white bg-[#2E7D32] rounded-md hover:opacity-90" href="./smart_advisory.html">
          <i class="fas fa-magic">
          </i>
          Generate Advisory
         </a>
        </div>
        <div class="divide-y divide-gray-200 rounded-md border border-gray-200 overflow-hidden" id="reportsList">
         <!-- Rows will be injected here -->
        </div>
        <div class="hidden py-8 text-center text-gray-500" id="listLoading">
         <i class="fas fa-spinner fa-spin mr-2">
         </i>
         Loading reports...
        </div>
        <!-- Pagination -->
        <div class="mt-4 flex items-center justify-between">
         <p class="text-sm text-gray-600" id="paginationInfo">
          Showing 0-0 of 0
         </p>
         <div class="flex items-center gap-2">
          <button class="px-3 py-2 text-sm border rounded-md hover:bg-gray-100 btn" id="prevPageBtn">
           <i class="fas fa-chevron-left">
           </i>
          </button>
          <span class="text-sm text-gray-700" id="currentPageLabel">
           Page 1
          </span>
          <button class="px-3 py-2 text-sm border rounded-md hover:bg-gray-100 btn" id="nextPageBtn">
           <i class="fas fa-chevron-right">
           </i>
          </button>
         </div>
        </div>
       </div>
      </div>
     </section>
    </main>
   </div>
  </div>
  <!-- Footer (Common Component) -->
  <footer class="w-full bg-white border-t border-gray-200">
   <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
    <div class="flex items-center gap-2">
     <img alt="Logo" class="h-5 w-5" onerror="this.src='https://ibb.co/JW4DnZwH'" src="https://i.ibb.co/p68Y2qBd/Logo-02.png"/>
     <span class="text-sm text-gray-600">
      YieldWise 
     </span>
    </div>
    <div class="flex items-center gap-4">
     <a class="text-sm text-gray-600 hover:text-[#2E7D32]" href="./home_dashboard.html">
      <i class="fas fa-home mr-1">
      </i>
      Home
     </a>
     <a class="text-sm text-gray-600 hover:text-[#2E7D32]" href="./smart_advisory.html">
      <i class="fas fa-seedling mr-1">
      </i>
      Advisory
     </a>
     <a class="text-sm text-gray-600 hover:text-[#2E7D32]" href="./tools_page.html">
      <i class="fas fa-tools mr-1">
      </i>
      Tools
     </a>
     <span class="mx-2 text-gray-300">
      |
     </span>
     <a class="text-sm text-gray-600 hover:text-[#2E7D32]" href="./terms.html">
      Terms
     </a>
     <a class="text-sm text-gray-600 hover:text-[#2E7D32]" href="./privacy.html">
      Privacy
     </a>
    </div>
   </div>
  </footer>
  <!-- Profile & Reports Logic -->
  <script>
   (function() {
    const storageKeys = {
        profile: 'farmerProfile',
        reports: 'savedReports',
        theme: 'uiTheme'
    };

    const defaultProfile = {
        name: 'Ravi Kumar',
        district: 'Nashik',
        landSize: 2.5,
        preferredCrop: 'Onion'
    };

    const defaultReports = [{
        id: 'rep-2025-001',
        title: 'Wheat Advisory - Rabi',
        crop: 'Wheat',
        location: 'Kanpur',
        date: '2025-09-18',
        summary: 'Apply urea at 60kg/acre; irrigate weekly; monitor rust.'
    }, {
        id: 'rep-2025-002',
        title: 'Rice Advisory - Kharif',
        crop: 'Rice',
        location: 'Kolkata',
        date: '2025-08-22',
        summary: 'Maintain 3-5 cm water; apply DAP; check for stem borer.'
    }, {
        id: 'rep-2025-003',
        title: 'Corn Advisory - Kharif',
        crop: 'Maize',
        location: 'Indore',
        date: '2025-07-05',
        summary: 'Use seed treatment; nitrogen split doses; pest scouting.'
    }, {
        id: 'rep-2025-004',
        title: 'Cotton Advisory',
        crop: 'Cotton',
        location: 'Surat',
        date: '2025-06-19',
        summary: 'Balanced fertilization; IPM for bollworm; timely picking.'
    }, {
        id: 'rep-2025-005',
        title: 'Soybean Advisory',
        crop: 'Soybean',
        location: 'Nagpur',
        date: '2025-05-11',
        summary: 'Rhizobium inoculation; weed control at 20 DAS.'
    }, {
        id: 'rep-2025-006',
        title: 'Onion Advisory',
        crop: 'Onion',
        location: 'Nashik',
        date: '2025-04-30',
        summary: 'Phosphorus at basal; thrips monitoring; avoid waterlogging.'
    }, {
        id: 'rep-2025-007',
        title: 'Pulses Advisory',
        crop: 'Chickpea',
        location: 'Jaipur',
        date: '2025-03-14',
        summary: 'Seed rate 75kg/ha; bio-fertilizers; watch for pod borer.'
    }];

    // Elements
    const userNameEl = document.getElementById('userName');
    const userDistrictEl = document.getElementById('userDistrict');
    const landSizeEl = document.getElementById('landSize');
    const preferredCropEl = document.getElementById('preferredCrop');
    const profileActionBtn = document.getElementById('profileActionBtn');
    const readProfileBtn = document.getElementById('readProfileBtn');
    const reportSearchEl = document.getElementById('reportSearch');
    const sortSelectEl = document.getElementById('sortSelect');
    const reportsListEl = document.getElementById('reportsList');
    const emptyStateEl = document.getElementById('emptyState');
    const listLoadingEl = document.getElementById('listLoading');
    const paginationInfoEl = document.getElementById('paginationInfo');
    const currentPageLabelEl = document.getElementById('currentPageLabel');
    const prevPageBtn = document.getElementById('prevPageBtn');
    const nextPageBtn = document.getElementById('nextPageBtn');
    const darkModeToggle = document.getElementById('darkModeToggle');

    let isEditMode = false;
    let reports = [];
    let filteredReports = [];
    let pageSize = 5;
    let currentPage = 1;

    // Init
    initTheme();
    initProfile();
    initReports();
    bindEvents();

    function initTheme() {
        try {
            const savedTheme = localStorage.getItem(storageKeys.theme) || 'light';
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
                document.body.classList.add('bg-gray-900', 'text-gray-100');
            }
        } catch (e) {}
    }

    function toggleTheme() {
        const isDark = document.documentElement.classList.toggle('dark');
        if (isDark) {
            document.body.classList.add('bg-gray-900', 'text-gray-100');
            localStorage.setItem(storageKeys.theme, 'dark');
        } else {
            document.body.classList.remove('bg-gray-900', 'text-gray-100');
            localStorage.setItem(storageKeys.theme, 'light');
        }
    }

    function initProfile() {
        try {
            const saved = localStorage.getItem(storageKeys.profile);
            const profile = saved ? JSON.parse(saved) : defaultProfile;
            if (!saved) localStorage.setItem(storageKeys.profile, JSON.stringify(profile));
            // Populate
            userNameEl.value = profile.name || '';
            userDistrictEl.value = profile.district || '';
            landSizeEl.value = profile.landSize != null ? profile.landSize : '';
            preferredCropEl.value = profile.preferredCrop || '';
            setEditMode(false);
        } catch (e) {
            console.error('Profile init error', e);
        }
    }

    function setEditMode(enabled) {
        isEditMode = enabled;
        userNameEl.disabled = !enabled;
        userDistrictEl.disabled = !enabled;
        landSizeEl.disabled = !enabled;
        preferredCropEl.disabled = !enabled;
        [userNameEl, userDistrictEl, landSizeEl, preferredCropEl].forEach(el => {
            if (enabled) {
                el.classList.remove('readonly-input');
            } else {
                el.classList.add('readonly-input');
            }
        });
        profileActionBtn.textContent = enabled ? 'Save Changes' : 'Edit Profile';
    }

    function saveProfile() {
        // Validation
        let valid = true;
        const name = userNameEl.value.trim();
        const district = userDistrictEl.value.trim();
        const landSize = parseFloat(landSizeEl.value);
        const crop = preferredCropEl.value.trim();

        document.getElementById('errorName').classList.add('hidden');
        document.getElementById('errorDistrict').classList.add('hidden');
        document.getElementById('errorLandSize').classList.add('hidden');

        if (!name) {
            document.getElementById('errorName').classList.remove('hidden');
            valid = false;
        }
        if (!district) {
            document.getElementById('errorDistrict').classList.remove('hidden');
            valid = false;
        }
        if (!(landSize >= 0)) {
            document.getElementById('errorLandSize').classList.remove('hidden');
            valid = false;
        }

        if (!valid) {
            Swal.fire({
                icon: 'error',
                title: 'Check Inputs',
                text: 'Please fill all required fields correctly.'
            });
            return;
        }
        const profile = {
            name,
            district,
            landSize,
            preferredCrop: crop
        };
        try {
            localStorage.setItem(storageKeys.profile, JSON.stringify(profile));
            setEditMode(false);
            Swal.fire({
                icon: 'success',
                title: 'Profile Saved!',
                timer: 1500,
                showConfirmButton: false
            });
        } catch (e) {
            Swal.fire({
                icon: 'error',
                title: 'Save Failed',
                text: 'Could not save profile locally.'
            });
        }
    }

    function readProfileAloud() {
        try {
            const name = userNameEl.value || 'Unknown';
            const district = userDistrictEl.value || 'Unknown district';
            const land = landSizeEl.value ? landSizeEl.value + ' acres' : 'unknown land size';
            const crop = preferredCropEl.value || 'no preferred crop';
            const text = `Farmer profile. Name ${name}. District ${district}. Land size ${land}. Preferred crop ${crop}.`;
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'en-IN';
            speechSynthesis.cancel();
            speechSynthesis.speak(utter);
        } catch (e) {}
    }

    function initReports() {
        try {
            const saved = localStorage.getItem(storageKeys.reports);
            reports = saved ? JSON.parse(saved) : defaultReports;
            if (!saved) localStorage.setItem(storageKeys.reports, JSON.stringify(reports));
            filteredReports = reports.slice();
            renderReports();
        } catch (e) {
            console.error('Reports init error', e);
        }
    }

    function bindEvents() {
        profileActionBtn.addEventListener('click', () => {
            if (!isEditMode) {
                setEditMode(true);
            } else {
                saveProfile();
            }
        });
        readProfileBtn.addEventListener('click', readProfileAloud);

        reportSearchEl.addEventListener('input', () => {
            currentPage = 1;
            applyFilters();
        });
        sortSelectEl.addEventListener('change', () => {
            currentPage = 1;
            applyFilters();
        });
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderReports();
            }
        });
        nextPageBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(filteredReports.length / pageSize) || 1;
            if (currentPage < totalPages) {
                currentPage++;
                renderReports();
            }
        });
        darkModeToggle.addEventListener('click', toggleTheme);

        // If navigated with #reports, scroll nicely
        if (window.location.hash === '#reports') {
            const el = document.getElementById('reports');
            if (el) el.scrollIntoView({
                behavior: 'smooth'
            });
        }
    }

    function applyFilters() {
        const q = (reportSearchEl.value || '').toLowerCase();
        filteredReports = reports.filter(r =>
            r.title.toLowerCase().includes(q) ||
            r.crop.toLowerCase().includes(q) ||
            r.location.toLowerCase().includes(q)
        );
        const sort = sortSelectEl.value;
        filteredReports.sort((a, b) => {
            if (sort === 'date_desc') return new Date(b.date) - new Date(a.date);
            if (sort === 'date_asc') return new Date(a.date) - new Date(b.date);
            if (sort === 'crop_asc') return a.crop.localeCompare(b.crop);
            if (sort === 'crop_desc') return b.crop.localeCompare(a.crop);
            return 0;
        });
        renderReports();
    }

    function renderReports() {
        listLoadingEl.classList.remove('hidden');
        reportsListEl.innerHTML = '';
        setTimeout(() => {
            listLoadingEl.classList.add('hidden');
            const total = filteredReports.length;
            if (total === 0) {
                emptyStateEl.classList.remove('hidden');
                paginationInfoEl.textContent = 'Showing 0-0 of 0';
                currentPageLabelEl.textContent = 'Page 1';
                return;
            }
            emptyStateEl.classList.add('hidden');

            const totalPages = Math.ceil(total / pageSize) || 1;
            currentPage = Math.max(1, Math.min(currentPage, totalPages));
            const startIdx = (currentPage - 1) * pageSize;
            const endIdx = Math.min(startIdx + pageSize, total);
            const pageItems = filteredReports.slice(startIdx, endIdx);

            pageItems.forEach(r => {
                const row = document.createElement('div');
                row.className = 'list-row flex items-center justify-between px-4 py-3';
                row.innerHTML = `
              <div class="flex items-center gap-3">
                <i class="fas fa-file-alt text-[#2E7D32]"></i>
                <div>
                  <p class="font-medium text-gray-800">${escapeHtml(r.title)}</p>
                  <p class="text-xs text-gray-500">${formatDate(r.date)} • ${escapeHtml(r.crop)} • ${escapeHtml(r.location)}</p>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <button class="px-2 py-1 text-sm border rounded-md hover:bg-gray-100 btn" aria-label="Read report aloud" data-read-id="${r.id}"><i class="fas fa-volume-up text-[#2E7D32]"></i></button>
                <a href="./advisory_report.html?reportId=${encodeURIComponent(r.id)}" class="px-2 py-1 text-sm text-white bg-[#2E7D32] rounded-md hover:opacity-90 btn"><i class="fas fa-eye mr-1"></i>View</a>
                <button class="px-2 py-1 text-sm border rounded-md hover:bg-red-50 text-red-600 btn" aria-label="Delete report" data-delete-id="${r.id}"><i class="fas fa-trash"></i></button>
              </div>
            `;
                reportsListEl.appendChild(row);
            });

            paginationInfoEl.textContent = `Showing ${startIdx + 1}-${endIdx} of ${total}`;
            currentPageLabelEl.textContent = `Page ${currentPage} of ${totalPages}`;

            // Attach handlers for new buttons
            Array.from(document.querySelectorAll('[data-delete-id]')).forEach(btn => {
                btn.addEventListener('click', () => deleteReport(btn.getAttribute('data-delete-id')));
            });
            Array.from(document.querySelectorAll('[data-read-id]')).forEach(btn => {
                btn.addEventListener('click', () => readReport(btn.getAttribute('data-read-id')));
            });
        }, 250);
    }

    function readReport(id) {
        try {
            const r = reports.find(x => x.id === id);
            if (!r) return;
            const text = `${r.title}. Location ${r.location}. Crop ${r.crop}. Date ${formatDate(r.date)}. Summary: ${r.summary}`;
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'en-IN';
            speechSynthesis.cancel();
            speechSynthesis.speak(utter);
        } catch (e) {}
    }

    function deleteReport(id) {
        Swal.fire({
            title: 'Delete Report?',
            text: 'This will remove the report from your device.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Delete'
        }).then((result) => {
            if (result.isConfirmed) {
                try {
                    reports = reports.filter(r => r.id !== id);
                    localStorage.setItem(storageKeys.reports, JSON.stringify(reports));
                    applyFilters();
                    Swal.fire({
                        icon: 'success',
                        title: 'Deleted',
                        timer: 1200,
                        showConfirmButton: false
                    });
                } catch (e) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Delete Failed',
                        text: 'Could not update local storage.'
                    });
                }
            }
        });
    }

    // Utilities
    function formatDate(d) {
        try {
            const date = new Date(d);
            return date.toLocaleDateString('en-IN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        } catch (e) {
            return d;
        }
    }

    function escapeHtml(str) {
        return String(str).replace(/[&<>"]/g, s => ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;'
        } [s]));
    }
})();
  </script>
 </body>
</html>
